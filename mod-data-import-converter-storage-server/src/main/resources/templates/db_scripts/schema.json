{
  "tables": [
    {
      "tableName": "job_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "match_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "action_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "mapping_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "job_to_match_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "job_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "match_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "job_to_action_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "job_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "match_to_match_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "match_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "match_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "match_to_action_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "match_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "action_to_action_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "action_to_match_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "match_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "action_to_mapping_profiles",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.0.0",
      "withMetadata": true,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "uniqueIndex": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ],
      "foreignKeys": [
        {
          "fieldName": "masterProfileId",
          "targetTable": "action_profiles",
          "tOps": "ADD"
        },
        {
          "fieldName": "detailProfileId",
          "targetTable": "mapping_profiles",
          "tOps": "ADD"
        }
      ]
    },
    {
      "tableName": "profile_snapshots",
      "generateId": false,
      "fromModuleVersion": "mod-data-import-converter-storage-1.1.0",
      "withMetadata": false,
      "pkColumnName": "_id",
      "index": [
        {
          "fieldName": "id",
          "tOps": "ADD"
        }
      ]
    }
  ],
  "scripts": [
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE FUNCTION get_profile_association_snapshot(_association_table text, _master_table text, _master_type text, _detail_table text, _detail_type text)  RETURNS TABLE(association_id uuid, master_id uuid, master json, master_type text, detail_id uuid, detail_type text, detail_order integer, detail json) AS $$ BEGIN RETURN query EXECUTE format(' SELECT association._id, association.masterprofileid AS master_id, json_agg(master.jsonb) AS master, ''%s'' AS master_type, association.detailprofileid AS detail_id, ''%s'' AS detail_type, CAST(association.jsonb->>''order'' AS integer) AS detail_order, json_agg(detail.jsonb) AS detail FROM %s association INNER JOIN %s master ON master._id = association.masterprofileid INNER JOIN %s detail ON detail._id = association.detailprofileid  GROUP BY association._id',  _master_type, _detail_type, _association_table, _master_table, _detail_table); END $$ language plpgsql;",
      "fromModuleVersion": "mod-data-import-converter-storage-1.1.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE VIEW associations_view AS SELECT association_id, master_id, master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('job_to_match_profiles', 'job_profiles', 'JOB_PROFILE', 'match_profiles', 'MATCH_PROFILE') UNION ALL SELECT association_id, master_id,master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('job_to_action_profiles', 'job_profiles', 'JOB_PROFILE', 'action_profiles', 'ACTION_PROFILE') UNION ALL SELECT association_id, master_id,master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('match_to_match_profiles', 'match_profiles', 'MATCH_PROFILE', 'match_profiles', 'MATCH_PROFILE') UNION ALL SELECT association_id, master_id,master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('match_to_action_profiles', 'match_profiles','MATCH_PROFILE', 'action_profiles', 'ACTION_PROFILE') UNION ALL SELECT association_id, master_id, master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('action_to_match_profiles', 'action_profiles', 'ACTION_PROFILE', 'match_profiles', 'MATCH_PROFILE') UNION ALL SELECT association_id, master_id,master, master_type, detail_id, detail_type, detail_order, detail FROM get_profile_association_snapshot('action_to_action_profiles', 'action_profiles', 'ACTION_PROFILE', 'action_profiles', 'ACTION_PROFILE') UNION ALL SELECT association_id, master_id, master, master_type, detail_id, detail_type, detail_order, detail  FROM get_profile_association_snapshot('action_to_mapping_profiles', 'action_profiles', 'ACTION_PROFILE', 'mapping_profiles', 'MAPPING_PROFILE'); ",
      "fromModuleVersion": "mod-data-import-converter-storage-1.1.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE RULE delete_associations_with_details AS ON DELETE TO associations_view DO INSTEAD (DELETE FROM action_to_action_profiles WHERE action_to_action_profiles.masterprofileid = OLD.master_id; DELETE FROM action_to_mapping_profiles WHERE action_to_mapping_profiles.masterprofileid = OLD.master_id; DELETE FROM action_to_match_profiles WHERE action_to_match_profiles.masterprofileid = OLD.master_id; DELETE FROM job_to_action_profiles WHERE job_to_action_profiles.masterprofileid = OLD.master_id; DELETE FROM job_to_match_profiles WHERE job_to_match_profiles.masterprofileid = OLD.master_id; DELETE FROM match_to_action_profiles WHERE match_to_action_profiles.masterprofileid = OLD.master_id; DELETE FROM match_to_match_profiles WHERE match_to_match_profiles.masterprofileid = OLD.master_id;);",
      "fromModuleVersion": "mod-data-import-converter-storage-1.2.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE FUNCTION get_job_profile_snapshot(jobProfileId uuid) RETURNS TABLE(snapshot json) AS $$ WITH RECURSIVE recursive_snapshot AS (SELECT job_profile._id AS association_id, CAST(NULL AS uuid) AS master_id, job_profile._id AS detail_id, 'JOB_PROFILE' detail_type, 0 AS detail_order, json_agg(job_profile.jsonb) detail FROM job_profiles AS job_profile WHERE job_profile._id = jobProfileId GROUP BY job_profile._id UNION ALL SELECT associations_view.association_id, associations_view.master_id AS master_id, associations_view.detail_id AS detail_id, associations_view.detail_type AS detail_type, associations_view.detail_order AS detail_order, associations_view.detail AS detail FROM associations_view INNER JOIN recursive_snapshot ON associations_view.master_id = recursive_snapshot.detail_id) SELECT row_to_json(row) FROM recursive_snapshot row ORDER BY row.detail_order ASC $$ language 'sql' VOLATILE;",
      "fromModuleVersion": "mod-data-import-converter-storage-1.1.0"
    }
  ]
}
